The Simple Mail Transfer Protocol (SMTP) is a protocol for sending emails in an IP network. It can be used between an email client and an outgoing mail server or between two SMTP servers.
# Footprinting the Service
To interact with the SMTP server, we can use the telnet tool to initialize a TCP connection with the SMTP server.
```
telnet <ip> 25
```
The command VRFY can be used to enumerate existing users on the system
```
telnet 10.129.14.128 25
```
```
VRFY root
```
We can see that the VRFY command is not disabled, and we can use this to enumerate valid users. This could potentially be leveraged to gather a list of users we could use to mount a password brute-forcing attack against the FTP and SSH services and perhaps others. Though this is relatively low-risk, it's worth noting down as a Low finding for our report as our clients should reduce their external attack surface as much as possible. If this is no valid business reason for this command to be enabled, then we should advise them to disable it.
Sometimes we may have to work through a web proxy. We can also make this web proxy connect to the SMTP server. The command that we would send would then look something like this
```
telnet 10.129.14.128 25
```
```
CONNECT 10.129.14.128:25 HTTP/1.0
```
We can also use the smtp-open-relay NSE script to identify the target SMTP server as an open relay using 16 different tests. If we also print out the output of the scan in detail, we will also be able to see which tests the script is running.
```
sudo nmap <ip> -p25 --script smtp-open-relay -v
```
## Enumerate Users
### nmap
```
nmap 10.129.179.86 -p25 --script=smtp-enum-users
```
We can check for it anyways but do not find an open relay which is good for our client!
### Using smtp-user-enum
https://github.com/cytopia/smtp-user-enum?tab=readme-ov-file#smiling_imp-expn-mode
#### RCPT mode
This is usually the most useful command to fish for usernames as VRFY and EXPN are often disabled. SMTP having higher response times means we have to increase the time to wait for a reply which can be done by increasing the -w script. It is VERY important to increase the wait response for the reply using -w to 20 or 25.
```
smtp-user-enum -M RCPT -U /home/kali/Desktop/footprinting-wordlist.txt -w 30 -t 10.129.188.186
```
```
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```
We can get a user and try to crack his password with hydra but with pop3 protocol for example
```
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3 (or smtp,imap4)
```
```
hydra -L <userfoundpreviously> -p 'Company01!' -f 10.10.110.20 pop3 (or smtp,imap4)
```
It's typically not worth spending much time brute-forcing authentication for externally-facing services. This could cause a service disruption, so even if we can make a user list, we can try a few weak passwords and move on.
# Protocol Specifics Attacks
## Open Relay
Identify if an SMTP port allows an open relay.
```
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```
Next, we can use any mail client to connect to the mail server and send our email.
```
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```
https://0xdf.gitlab.io/2022/10/29/htb-trick.html