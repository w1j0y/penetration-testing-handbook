DNS is a system for resolving computer names into IP addresses, and it does not have a central database. The information is distributed over many thousands of name servers. Globally distributed DNS servers translate domain names into IP addresses and thus control which server a user can reach via a particular domain. Zone transfer refers to the transfer of zones to another server in DNS, which generally happens over TCP port 53. This procedure is abbreviated Asynchronous Full Transfer Zone (AXFR).
# Enumeration
DNS holds interesting information for an organization, we can understand how a company operates and the services they provide, as well as third-party service providers like emails.
```
nmap -p53 -Pn -sV -sC 10.10.110.213
```
## DNS Zone Transfer
A DNS zone is a portion of the DNS namespace that a specific organization or administrator manages. Since DNS comprises multiple DNS zones, DNS servers utilize DNS zone transfers to copy a portion of their database to another DNS server. Unless a DNS server is configured correctly (limiting which IPs can perform a DNS zone transfer), anyone can ask a DNS server for a copy of its zone information since DNS zone transfers do not require any authentication.
An attacker could leverage this DNS zone transfer vulnerability to learn more about the target organization's DNS namespace, increasing the attack surface. For exploitation, we can use the `dig` utility with DNS query type `AXFR` option to dump the entire DNS namespaces from a vulnerable DNS server:
```
dig AXFR @ns1.inlanefreight.htb inlanefreight.htb
```
DNS Zone Transfer to see if we can enumerate any valid subdomains for further exploration and expand our testing scope
Tools like Fierce can also be used to enumerate all DNS servers of the root domain and scan for a DNS zone transfer:
```
fierce --domain zonetransfer.me
```
If DNS were not in play, we could also perform vhost enumeration using a tool such as ffuf. Let's try it here to see if we find anything else that the zone transfer missed.
```
ffuf -w namelist.txt:FUZZ -u http://10.129.203.101/ -H 'Host:FUZZ.inlanefreight.local' -fs <depends>
```
# Footprinting the Service
query a DNS server's version using a class CHAOS query and type TXT
```
dig CH TXT version.bind <ip>
```
use the option ANY to view all available records. This will cause the server to show us all available entries that it is willing to disclose. It is important to note that not all entries from the zones will be shown.
```
dig any inlanefreight.htb @<ip>
```
Zone transfer refers to the transfer of zones to another server in DNS, which generally happens over TCP port 53. This procedure is abbreviated Asynchronous Full Transfer Zone (AXFR)
### DIG - AXFR Zone Transfer
```
dig axfr inlanefreight.htb @10.129.14.128
```
### DIG - AXFR Zone Transfer - Internal
```
dig axfr internal.inlanefreight.htb @10.129.14.128
```
**Be careful for internal ftp services**
## Subdomain Brute Forcing
### bash
```
for sub in $(cat /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
```
### dnsenum
```
dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
```
#### Querying: A Records for a Subdomain
```
nslookup -query=A $TARGET
```

# Domain Takeovers & Subdomain Enumeration
`Domain takeover` is registering a non-existent domain name to gain control over another domain. If attackers find an expired domain, they can claim that domain to perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain. Domain takeover is also possible with subdomains called `subdomain takeover`
## Subdomain Enumeration
Before performing a subdomain takeover, we should enumerate subdomains for a target domain using tools like Subfinder
```
./subfinder -d inlanefreight.com -v
```
https://github.com/projectdiscovery/subfinder

An excellent alternative is a tool called `Subbrute`. This tool allows us to use self-defined resolvers and perform pure DNS brute-forcing attacks during internal penetration tests on hosts that do not have Internet access.
```
git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
```
```
cd subbrute
```
```
echo "ns1.inlanefreight.com" > ./resolvers.txt
```
```
./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt
```
The tool has found four subdomains associated with inlanefreight.com. Using the nslookup or host command, we can enumerate the CNAME records for those subdomains.
The support subdomain has an alias record pointing to an AWS S3 bucket. However, the URL https://support.inlanefreight.com shows a NoSuchBucket error indicating that the subdomain is potentially vulnerable to a subdomain takeover. Now, we can take over the subdomain by creating an AWS S3 bucket with the same subdomain name.
## Exercise to find flag in DNS
- First you have to determine the domain name of the host by using nslookup 
- Add the IP to /etc/host with the target name
```
nslookup -query=ANY inlanefreight.htb 10.129.148.37
```
- Found nameserver = ns.inlanefreight.htb
- Add it to the /etc/hosts file with the same IP address of the attack host (inlanefreight.htb)
- Next you use subbrute to find the subdomains while putting the nameserver in the resolvers text file and the original name of the domain in the command
	- Include “ns.inlanefreight.htb” in the resolvers text file and not the subdomain
```
./subbrute.py inlanefreight.htb -s ./names.txt -r ./resolvers.txt
```
- After finding the subdomains, we use nslookup again to find the flag
```
nslookup -type=any -query=AXFR hr.inlanefreight.htb 10.129.148.37
```
# Domain Information
## crt.sh: find subdomains
```
curl -s https://crt.sh/\\?q\\=example.com\\&output\\=json | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
```
Save them into a list called subdomainlist then determine the ip address for each one
```
for i in $(cat subdomainlist);do host $i | grep "has address" | grep example.com | cut -d" " -f1,4;done
```
## Shodan
Shodan can be used to find devices and systems permanently connected to the Internet like Internet of Things (IoT)
```
for i in $(cat subdomainlist);do host $i | grep "has address" | grep example.com | cut -d" " -f4 >> ip-addresses.txt;done
```
```
for i in $(cat ip-addresses.txt);do shodan host $i;done
```
## DNS Records
```
dig any example.com
```
## Passive Infrastructure Identification
To get a list of crawled URLs from a domain with the date it was obtained, we can add the -dates switch to our command as follows:
```
waybackurls -dates https://facebook.com > waybackurls.txt
```
